define("app/linPhasePorMatrix",["require","underscore","utils","tool","graph","checkbox","hslider","vslider","text","button","curve","line","diamond","polygon","cross","arrow"],function(require){"use strict";var _=require("underscore"),U=require("utils"),Tool=require("tool"),Graph=require("graph"),Checkbox=require("checkbox"),HSlider=require("hslider"),VSlider=require("vslider"),Text=require("text"),Button=require("button"),Curve=require("curve"),Line=require("line"),Diamond=require("diamond"),Polygon=require("polygon"),Cross=require("cross"),Arrow=require("arrow"),tool,detGraph,portraitGraph,eigenGraph,trSlider,detSlider,aSlider,bSlider,cSlider,dSlider,companionCb,eigenCb,xReadoutText,yReadoutText,eigenval1Text,eigenval2Text,zoneText,diffEqText,matrixLabel,aText,bText,cText,dText,clearBtn,cyanArea,greenArea,yellowArea,parabolaCurve,horizontalLine,verticalLine,cross,preDrawnCurves=[],fixedPreDrawnArrows=[],movingPreDrawnArrows=[],preDrawnLines=[],userCurves=[],userArrows=[],userDiamonds=
[],initCurvePoints=[new Point2D(2,0),new Point2D(0,2),new Point2D(-2,0),new Point2D(0,-2)],initLinePoints=[new Point2D(1,1),new Point2D(-1,1),new Point2D(-1,-1),new Point2D(1,-1)],initArrowPoints=[new Point2D(1,1),new Point2D(-1,1),new Point2D(-1,-1),new Point2D(1,-1)],arrowTipPoints=[],eigenDiamond1,eigenDiamond2,trMin=-4,trMax=4,detMin=-4,detMax=5,det=1,tr=3,a=0,b=1,c=-1,d=3,eigen,detPrev=det,trPrev=tr,xPara=[],yPara=[],CLOSE=.05,fitInc=0,lastAddedIsArrow,curveClass={cyan:"curve-cyan",green:"curve-green",red:"curve-red",yellow:"curve-yellow"},diamondClass={cyan:"diamond-cyan",green:"diamond-green",red:"diamond-red",yellow:"diamond-yellow"},textClass={cyan:"text-cyan",green:"text-green",red:"text-red",yellow:"text-yellow"},textClassCenter={cyan:"text-cyan-center",green:"text-green-center",red:"text-red-center",yellow:"text-yellow-center"},state={a:a,b:b,c:c,d:d,isCompanionMatrix:!0};initializeTool();function getState(){return JSON.stringify(state)}function setState(stateStr){state=JSON
.parse(stateStr),updateStateFromOutside()}function getGrade(){return JSON.stringify(state)}window.linPhasePorMatrix={getState:getState,setState:setState,getGrade:getGrade};function updateStateFromOutside(){a=state.a,b=state.b,c=state.c,d=state.d,aSlider.setValue(a),bSlider.setValue(b),cSlider.setValue(c),dSlider.setValue(d),companionCb.setChecked(state.isCompanionMatrix),sliderMouseDown()}function updateStateFromInside(){state.a=a,state.b=b,state.c=c,state.d=d,state.isCompanionMatrix=companionCb.isChecked}function initializeTool(){try{U.testForFeatures(!1,!1,!1,!0)}catch(err){window.alert(err.toString()+" The tool is disabled.")}U.enableHelpLink("help-text","help-link"),initTool()}function initTool(){var toolContainer=document.getElementById("daimp-tool-container");tool=new Tool(toolContainer),detGraph=new Graph(80,30,160,180),detGraph.setPlottingBounds(trMin,trMax,detMin,detMax),detGraph.setXAxis(0),detGraph.setXText("tr"),detGraph.setXShortTicks(1),detGraph.setXLongTicks(2),detGraph.setAutomaticXLabels
(2,0,!1),detGraph.setYAxis(0),detGraph.setYText("det"),detGraph.setYShortTicks(1),detGraph.setYLongTicks(2),detGraph.setAutomaticYLabels(2,0,!1),detGraph.hasReadout=!0,detGraphShowAll(!1),tool.add(detGraph),detGraph.addEventListener("mousedown",detGraphMouseDown),detGraph.addEventListener("mousedrag",detGraphMouseDrag),portraitGraph=new Graph(detGraph.x+detGraph.width+130,detGraph.y,400,400),portraitGraph.setPlottingBounds(-4,4,-4,4),portraitGraph.setXAxis(0),portraitGraph.setXText("x"),portraitGraph.setYAxis(0),portraitGraph.setYText("y"),tool.add(portraitGraph),portraitGraph.addEventListener("mousedown",portraitGraphMouseDown),portraitGraph.addEventListener("mousedrag",portraitGraphMouseDrag),portraitGraph.addEventListener("mouseover",graphShowReadouts),portraitGraph.addEventListener("mousemove",graphShowReadouts),portraitGraph.addEventListener("mouseout",graphHideReadouts),eigenGraph=new Graph(detGraph.x-30,portraitGraph.y+portraitGraph.height+20,100,100),eigenGraph.setPlottingBounds
(-4,4,-4,4),eigenGraph.setXAxis(0),eigenGraph.setXText("Re"),eigenGraph.setXShortTicks(1),eigenGraph.setXLongTicks(2),eigenGraph.setAutomaticXLabels(2,0,!1),eigenGraph.setYAxis(0),eigenGraph.setYText("Im"),eigenGraph.setYShortTicks(1),eigenGraph.setYLongTicks(2),eigenGraph.setAutomaticYLabels(2,0,!1),eigenGraph.setVisibility(!1),tool.add(eigenGraph),trSlider=new HSlider(detGraph.x,detGraph.y+detGraph.height+40,detGraph.width,50),trSlider.setPlottingBounds(trMin,trMax),trSlider.setText("tr"),trSlider.setShortTicks(1),trSlider.setLongTicks(2),trSlider.setValue(tr,2),trSlider.setAutomaticLabels(2,0,!1),tool.add(trSlider),trSlider.addEventListener("mousedown",_.bind(sliderMouseDown,trSlider)),trSlider.addEventListener("mousedrag",_.bind(sliderMouseDown,trSlider)),detSlider=new VSlider(detGraph.x-30,detGraph.y,20,detGraph.height),detSlider.setPlottingBounds(detMin,detMax),detSlider.setText("det"),detSlider.setShortTicks(1),detSlider.setLongTicks(2),detSlider.setValue(det,2),detSlider.setAutomaticLabels
(2,0,!1),tool.add(detSlider),detSlider.addEventListener("mousedown",_.bind(sliderMouseDown,detSlider)),detSlider.addEventListener("mousedrag",_.bind(sliderMouseDown,detSlider)),aSlider=new HSlider(portraitGraph.x,portraitGraph.y+portraitGraph.height+75,160,50),aSlider.setPlottingBounds(-4,4),aSlider.setText("a"),aSlider.setShortTicks(1),aSlider.setLongTicks(2),aSlider.setValue(a,2),aSlider.setAutomaticLabels(2,0,!1),aSlider.setVisibility(!1),tool.add(aSlider),aSlider.addEventListener("mousedown",_.bind(sliderMouseDown,aSlider)),aSlider.addEventListener("mousedrag",_.bind(sliderMouseDown,aSlider)),bSlider=new HSlider(aSlider.x+aSlider.width+80,aSlider.y,160,50),bSlider.setPlottingBounds(-4,4),bSlider.setText("b"),bSlider.setShortTicks(1),bSlider.setLongTicks(2),bSlider.setValue(b,2),bSlider.setAutomaticLabels(2,0,!1),bSlider.setVisibility(!1),tool.add(bSlider),bSlider.addEventListener("mousedown",_.bind(sliderMouseDown,bSlider)),bSlider.addEventListener("mousedrag",_.bind(sliderMouseDown
,bSlider)),cSlider=new HSlider(aSlider.x,aSlider.y+50,160,50),cSlider.setPlottingBounds(-4,4),cSlider.setText("c"),cSlider.setShortTicks(1),cSlider.setLongTicks(2),cSlider.setValue(c,2),cSlider.setAutomaticLabels(2,0,!1),tool.add(cSlider),cSlider.addEventListener("mousedown",_.bind(sliderMouseDown,cSlider)),cSlider.addEventListener("mousedrag",_.bind(sliderMouseDown,cSlider)),dSlider=new HSlider(bSlider.x,bSlider.y+50,160,50),dSlider.setPlottingBounds(-4,4),dSlider.setText("d"),dSlider.setShortTicks(1),dSlider.setLongTicks(2),dSlider.setValue(d,2),dSlider.setAutomaticLabels(2,0,!1),tool.add(dSlider),dSlider.addEventListener("mousedown",_.bind(sliderMouseDown,dSlider)),dSlider.addEventListener("mousedrag",_.bind(sliderMouseDown,dSlider)),xReadoutText=new Text(portraitGraph.x,portraitGraph.y+portraitGraph.height+20),xReadoutText.addText("x = ","normal-text"),tool.add(xReadoutText),yReadoutText=new Text(xReadoutText.x,xReadoutText.y+20),yReadoutText.addText("y = ","normal-text"),tool.add(yReadoutText
),zoneText=new Text(portraitGraph.x+portraitGraph.width/2,portraitGraph.y+portraitGraph.height+20),zoneText.addText("","centered-text"),tool.add(zoneText),diffEqText=new Text(zoneText.x,zoneText.y+20),diffEqText.addText("u' = A u","centered-text"),tool.add(diffEqText),eigenval1Text=new Text(eigenGraph.x+eigenGraph.width+40,eigenGraph.y+eigenGraph.height/2-5),eigenval1Text.addText(U.STR.lambda,"normal-text"),eigenval1Text.addSubScript("1","normal-text"),eigenval1Text.addText(" = ","normal-text"),eigenval1Text.setVisibility(!1),tool.add(eigenval1Text),eigenval2Text=new Text(eigenval1Text.x,eigenval1Text.y+20),eigenval2Text.addText(U.STR.lambda,"normal-text"),eigenval2Text.addSubScript("2","normal-text"),eigenval2Text.addText(" = ","normal-text"),eigenval2Text.setVisibility(!1),tool.add(eigenval2Text),companionCb=new Checkbox(trSlider.x,trSlider.y+35,50,50),companionCb.addText("Companion Matrix"),companionCb.setChecked(!0),tool.add(companionCb),companionCb.addEventListener("mousedown",_.bind
(checkboxMouseDown,companionCb)),eigenCb=new Checkbox(eigenGraph.x,companionCb.y+110,50,50),eigenCb.addText("Eigenvalues"),tool.add(eigenCb),eigenCb.addEventListener("mousedown",_.bind(checkboxMouseDown,eigenCb)),matrixLabel=new Text(companionCb.x,companionCb.y+60),matrixLabel.addText("A = ","normal-text"),tool.add(matrixLabel),aText=new Text(companionCb.x+45,companionCb.y+50),aText.addText("a","normal-text"),tool.add(aText),bText=new Text(aText.x+60,aText.y),bText.addText("b","normal-text"),tool.add(bText),cText=new Text(aText.x,aText.y+20),cText.addText("c","normal-text"),tool.add(cText),dText=new Text(bText.x,bText.y+20),dText.addText("d","normal-text"),tool.add(dText),addLeftBracket(matrixLabel.x+32,matrixLabel.y-30,50,"mat-a-bracket"),addRightBracket(matrixLabel.x+150,matrixLabel.y-30,50,"mat-a-bracket"),clearBtn=new Button(portraitGraph.x+portraitGraph.width-70,portraitGraph.y+portraitGraph.height+25,70,20),clearBtn.addText("Clear"),tool.add(clearBtn),clearBtn.addEventListener("mousedown"
,buttonMouseDown),portraitGraph.setCrosshairs(!0,!0),eigen=getEigen(),addEigenDiamonds(),addPreDrawnCurves(),setPreDrawnCurves(),addFixedPreDrawnArrows(),setFixedPreDrawnArrows(),eigen.eigen1.y===0&&(addPreDrawnLines(),setPreDrawnLines(),addMovingPreDrawnArrows(),setMovingPreDrawnArrows()),updateText();var len=161;xPara=new Array(len),yPara=new Array(len);var i=0,x=trMin,xInc=.05;while(i<len)xPara[i]=x,yPara[i]=parabola(x),x+=xInc,i++;cyanArea=new Polygon(detGraph,[trMin,0,trMax,0,trMax,detMin,trMin,detMin],"diamond-cyan"),xPara.push(trMax),xPara.push(trMin),yPara.push(0),yPara.push(0),greenArea=new Polygon(detGraph,xPara,yPara,"diamond-green"),xPara.pop(),xPara.pop(),yPara.pop(),yPara.pop(),xPara.push(trMax),xPara.push(trMin),yPara.push(detMax),yPara.push(detMax),yellowArea=new Polygon(detGraph,xPara,yPara,"diamond-yellow"),xPara.pop(),xPara.pop(),yPara.pop(),yPara.pop(),parabolaCurve=new Curve(detGraph,xPara,yPara,"curve-red"),horizontalLine=new Line(detGraph,trMin,0,trMax,0,"curve-red-thick"
),verticalLine=new Line(detGraph,0,0,0,detMax,"curve-red"),cross=new Cross(detGraph,tr,det,6,1,"cross"),tool.finalize()}function parabola(x){return x*x/4}function addLeftBracket(x,y,h,cssClass){var l1,l2,l3;l1=U.createLine(tool.svg,x,y,x,y+h,cssClass),l2=U.createLine(tool.svg,x,y,x+6,y,cssClass),l3=U.createLine(tool.svg,x,y+h,x+6,y+h,cssClass)}function addRightBracket(x,y,h,cssClass){var l1,l2,l3;l1=U.createLine(tool.svg,x,y,x,y+h,cssClass),l2=U.createLine(tool.svg,x,y,x-6,y,cssClass),l3=U.createLine(tool.svg,x,y+h,x-6,y+h,cssClass)}function setSlider(){aSlider.setPlottingBounds(-2,1),aSlider.setAutomaticLabels(1,0,!1),aSlider.setValue(0)}function detGraphShowAll(showAll){detGraph.showXAxis(showAll),detGraph.showXText(showAll),detGraph.showXShortTicks(showAll),detGraph.showXLongTicks(showAll),detGraph.showXLabels(showAll),detGraph.showYAxis(showAll),detGraph.showYText(showAll),detGraph.showYShortTicks(showAll),detGraph.showYLongTicks(showAll),detGraph.showYLabels(showAll)}function dxdt(
x,y){return a*x+b*y}function dydt(x,y){return c*x+d*y}function buttonMouseDown(){clearPreDrawnShapes(),clearUserShapes()}function sliderMouseDown(){var dT,dD,slope;this===aSlider?a=aSlider.value:this===bSlider?b=bSlider.value:this===cSlider?c=cSlider.value:this===dSlider?d=dSlider.value:this===trSlider?tr=trSlider.value:det=detSlider.value,this!==trSlider&&this!==detSlider&&(tr=trace(a,b,c,d),det=determinant(a,b,c,d)),nearRedBoundary()&&(dT=tr-trPrev,dD=det-detPrev,nearHorizontalAxis()?fitInc>1&&dD!==0&&(slope=dT/dD,tr=getTrIntWithHorizontalAxis(slope,tr,det),det=0):nearParabola()?(dT!==0&&(slope=dD/dT,tr=getTrIntWithParabola(slope,tr,det)),det=tr*tr/4):nearVerticalAxis()&&fitInc>1&&dT!==0&&(slope=dD/dT,det=getDetIntWithVerticalAxis(slope,tr,det),tr=0),trSlider.setValue(tr),detSlider.setValue(det),companionCb.isChecked||(this===aSlider?(a=tr-d,aSlider.setValue(a)):this===bSlider?(c!==0&&(b=(a*d-det)/c),bSlider.setValue(b)):this===cSlider?(b!==0&&(c=(a*d-det)/b),cSlider.setValue(c)):this===
dSlider&&(d=tr-a,dSlider.setValue(d))),fitInc=0),fitInc++,companionCb.isChecked&&(a=0,b=1,c=-det,d=tr,aSlider.setValue(a),bSlider.setValue(b),cSlider.setValue(c),dSlider.setValue(d)),eigen=getEigen(),setEigenDiamonds(),trSlider.setValue(tr),detSlider.setValue(det),cross.setXY(tr,det),trPrev=tr,detPrev=det,clearUserShapes();if(matrixIsZero(a,b,c,d)){buttonMouseDown(),updateText();return}preDrawnCurves.length===0?addPreDrawnCurves():setPreDrawnCurves(),fixedPreDrawnArrows.length===0?(addFixedPreDrawnArrows(),setFixedPreDrawnArrows()):setFixedPreDrawnArrows(),eigen.eigen1.y===0?(preDrawnLines.length===0?(addPreDrawnLines(),setPreDrawnLines()):setPreDrawnLines(),movingPreDrawnArrows.length===0?(addMovingPreDrawnArrows(),setMovingPreDrawnArrows()):setMovingPreDrawnArrows()):(clearShapes(preDrawnLines,"line"),clearShapes(movingPreDrawnArrows,"arrow")),updateText()}function portraitGraphMouseDown(mpos){addUserShape(mpos),setUserShape(mpos),graphShowReadouts(mpos)}function portraitGraphMouseDrag
(mpos){setUserShape(mpos),graphShowReadouts(mpos)}function graphHideReadouts(mpos){xReadoutText.setText(0,"x ="),yReadoutText.setText(0,"y =")}function graphShowReadouts(mpos){xReadoutText.setText(0,"x = "+mpos.x.toFixed(2)),yReadoutText.setText(0,"y = "+mpos.y.toFixed(2))}function detGraphMouseDown(mpos){companionCb.isChecked&&(tr=mpos.x,det=mpos.y,a=0,b=1,c=-det,d=tr,trSlider.setValue(tr),detSlider.setValue(det),aSlider.setValue(a),bSlider.setValue(b),cSlider.setValue(c),dSlider.setValue(d),sliderMouseDown()),graphHideReadouts()}function detGraphMouseDrag(mpos){companionCb.isChecked&&detGraphMouseDown(mpos)}function updateText(){aText.setText(0,a.toFixed(2)),bText.setText(0,b.toFixed(2)),cText.setText(0,c.toFixed(2)),dText.setText(0,d.toFixed(2)),zoneText.setText(0,eigen.zone),zoneText.setClass(0,textClassCenter[eigen.color]),eigenval1Text.setClass(0,textClass[eigen.color]),eigenval1Text.setClass(1,textClass[eigen.color]),eigenval1Text.setClass(2,textClass[eigen.color]),eigenval1Text.
setText(2," = "+eigen.eigen1.toComplexString(),textClass[eigen.color]),eigenval2Text.setClass(0,textClass[eigen.color]),eigenval2Text.setClass(1,textClass[eigen.color]),eigenval2Text.setClass(2,textClass[eigen.color]),eigenval2Text.setText(2," = "+eigen.eigen2.toComplexString(),textClass[eigen.color])}function checkboxMouseDown(){this===companionCb?this.isChecked?(a=0,b=1,aSlider.setValue(a),bSlider.setValue(b),aSlider.setVisibility(!1),bSlider.setVisibility(!1),trSlider.setVisibility(!0),detSlider.setVisibility(!0),detGraphShowAll(!1),sliderMouseDown()):(aSlider.setVisibility(!0),bSlider.setVisibility(!0),trSlider.setVisibility(!1),detSlider.setVisibility(!1),detGraphShowAll(!0)):(eigenGraph.setVisibility(eigenCb.isChecked),eigenval1Text.setVisibility(eigenCb.isChecked),eigenval2Text.setVisibility(eigenCb.isChecked))}function inAllowedBounds(pt){var xMin=2*portraitGraph.xMin,xMax=2*portraitGraph.xMax,yMin=2*portraitGraph.yMin,yMax=2*portraitGraph.yMax;return pt.x<=xMax&&pt.x>=xMin&&pt.
y<=yMax&&pt.y>=yMin}function getTrIntWithParabola(slope,tr0,det0){var disc=4*(slope*slope+det0-slope*tr0),tr1,tr2,d1,d2;return disc>=0?(tr1=2*slope-Math.sqrt(disc),tr2=2*slope+Math.sqrt(disc)):(tr1=0,tr2=0),d1=Math.abs(tr1-tr0),d2=Math.abs(tr2-tr0),d1<=d2?tr1:tr2}function getTrIntWithHorizontalAxis(slope,tr0,det0){return tr0-slope*det0}function getDetIntWithVerticalAxis(slope,tr0,det0){return det0-slope*tr0}function nearRedBoundary(){return nearParabola()||nearHorizontalAxis()||nearVerticalAxis()}function nearParabola(){var parab=tr*tr/4;return Math.abs(det-parab)<CLOSE}function nearHorizontalAxis(){return Math.abs(det)<CLOSE}function nearVerticalAxis(){return Math.abs(tr)<CLOSE&&det>=0}function addEigenDiamonds(){eigenDiamond1=new Diamond(eigenGraph,eigen.eigen1.x,eigen.eigen1.y,3,diamondClass[eigen.color]),eigenDiamond2=new Diamond(eigenGraph,eigen.eigen2.x,eigen.eigen2.y,3,diamondClass[eigen.color])}function setEigenDiamonds(){eigenDiamond1.setXY(eigen.eigen1.x,eigen.eigen1.y),eigenDiamond1
.setClass(diamondClass[eigen.color]),eigenDiamond2.setXY(eigen.eigen2.x,eigen.eigen2.y),eigenDiamond2.setClass(diamondClass[eigen.color])}function addPreDrawnCurves(){preDrawnCurves.length===0&&_.each(initCurvePoints,function(pt){addSolutionCurve(pt,preDrawnCurves)})}function addFixedPreDrawnArrows(){_.each(initCurvePoints,function(pt){addSolutionArrow(pt,fixedPreDrawnArrows)})}function addMovingPreDrawnArrows(){var arrow,i;for(i=0;i<4;i++)arrow=new Arrow(portraitGraph,initArrowPoints[i].x,initArrowPoints[i].y,arrowTipPoints[i].x,arrowTipPoints[i].y,diamondClass[eigen.color]),arrow.setHead(3,6),arrow.alwaysShowHead=!0,movingPreDrawnArrows.push(arrow)}function addPreDrawnLines(){_.each(initLinePoints,function(pt){addSolutionLine(pt,preDrawnLines)})}function addUserShape(pt){addSolutionCurve(pt,userCurves),regionIsDiamond(pt)?(addSolutionDiamond(pt,userDiamonds),lastAddedIsArrow=!1):(addSolutionArrow(pt,userArrows),lastAddedIsArrow=!0)}function setPreDrawnCurves(){_.each(initCurvePoints,function(
pt,ind){setSolutionCurve(pt,preDrawnCurves,2*ind)})}function setFixedPreDrawnArrows(){_.each(initCurvePoints,function(pt,ind){setSolutionArrow(pt,fixedPreDrawnArrows,ind)}),det===0?(fixedPreDrawnArrows[0].setVisibility(!1),fixedPreDrawnArrows[2].setVisibility(!1)):(fixedPreDrawnArrows[0].setVisibility(!0),fixedPreDrawnArrows[2].setVisibility(!0))}function setMovingPreDrawnArrows(){var i;for(i=0;i<4;i++)movingPreDrawnArrows[i].setXY(initArrowPoints[i].x,initArrowPoints[i].y,arrowTipPoints[i].x,arrowTipPoints[i].y),movingPreDrawnArrows[i].setClass(diamondClass[eigen.color]),det===0&&arrowTipPoints[i].y===0?movingPreDrawnArrows[i].setVisibility(!1):movingPreDrawnArrows[i].setVisibility(!0)}function setPreDrawnLines(){var lambda1=eigen.eigen1.x,lambda2=eigen.eigen2.x,slope1,slope2,r=3,xa1,ya1,xa2,ya2;initLinePoints.length=0,lambda1-d!==0?slope1=c/(lambda1-d):b!==0?slope1=(lambda1-a)/b:slope1=1e3,lambda2-d!==0?slope2=c/(lambda2-d):b!==0?slope2=(lambda2-a)/b:slope2=1e3,initLinePoints=[new Point2D
(4,4*slope1),new Point2D(-4,-4*slope1),new Point2D(4,4*slope2),new Point2D(-4,-4*slope2)],_.each(initLinePoints,function(pt,ind){setSolutionLine(pt,preDrawnLines,ind)}),xa1=r/Math.sqrt(1+slope1*slope1),ya1=slope1*xa1,xa2=r/Math.sqrt(1+slope2*slope2),ya2=slope2*xa2,det!==tr*tr/4?(arrowTipPoints=[new Point2D(xa1,ya1),new Point2D(-xa1,-ya1),new Point2D(xa2,ya2),new Point2D(-xa2,-ya2)],eigen.color==="red"||eigen.color==="cyan"?initArrowPoints=[new Point2D(5,5*slope1),new Point2D(-5,-5*slope1),new Point2D(0,0),new Point2D(0,0)]:eigen.color==="green"&&(tr<0?initArrowPoints=[new Point2D(5,5*slope1),new Point2D(-5,-5*slope1),new Point2D(5,5*slope2),new Point2D(-5,-5*slope2)]:initArrowPoints=[new Point2D(0,0),new Point2D(0,0),new Point2D(0,0),new Point2D(0,0)])):(arrowTipPoints=[new Point2D(xa1,ya1),new Point2D(-xa1,-ya1),new Point2D(xa1,ya1),new Point2D(-xa1,-ya1)],tr<0?initArrowPoints=[new Point2D(5,5*slope1),new Point2D(-5,-5*slope1),new Point2D(5,5*slope2),new Point2D(-5,-5*slope2)]:initArrowPoints=
[new Point2D(0,0),new Point2D(0,0),new Point2D(0,0),new Point2D(0,0)])}function setUserShape(pt){var isDiamond=regionIsDiamond(pt),arrow,diamond;setSolutionCurve(pt,userCurves,userCurves.length-2),lastAddedIsArrow?isDiamond?(removeSolutionArrow(),addSolutionDiamond(pt,userDiamonds),setSolutionDiamond(pt,userDiamonds,userDiamonds.length-1),lastAddedIsArrow=!1):setSolutionArrow(pt,userArrows,userArrows.length-1):isDiamond?setSolutionDiamond(pt,userDiamonds,userDiamonds.length-1):(removeSolutionDiamond(),addSolutionArrow(pt,userArrows),setSolutionArrow(pt,userArrows,userArrows.length-1),lastAddedIsArrow=!0)}function clearPreDrawnShapes(pt){clearShapes(preDrawnCurves,"curve"),clearShapes(preDrawnLines,"line"),clearShapes(fixedPreDrawnArrows,"arrow"),clearShapes(movingPreDrawnArrows,"arrow")}function clearUserShapes(pt){clearShapes(userCurves,"curve"),clearShapes(userArrows,"arrow"),clearShapes(userDiamonds,"diamonds")}function addSolutionCurve(pt,curveGroup){var points;points=getSolutionPoints
(pt,.05,500),curveGroup.push(new Curve(portraitGraph,points,curveClass[eigen.color])),points=getSolutionPoints(pt,-0.05,500),curveGroup.push(new Curve(portraitGraph,points,curveClass[eigen.color]))}function addSolutionLine(pt,lineGroup){lineGroup.push(new Line(portraitGraph,0,0,pt.x,pt.y,curveClass[eigen.color]))}function addSolutionArrow(pt,arrowGroup){var nextPt=getSolutionPoints(pt,.02,5),arrow=new Arrow(portraitGraph,pt.x,pt.y,nextPt[2],nextPt[3],diamondClass[eigen.color]);arrow.setHead(3,6),arrow.alwaysShowHead=!0,arrowGroup.push(arrow)}function addSolutionDiamond(pt,diamondGroup){var diamond=new Diamond(portraitGraph,pt.x,pt.y,3,diamondClass[eigen.color]);diamondGroup.push(diamond)}function setSolutionCurve(pt,curveGroup,curveIndex){var points;points=getSolutionPoints(pt,.05,500),curveGroup[curveIndex].setPoints(points),curveGroup[curveIndex].setClass(curveClass[eigen.color]),points=getSolutionPoints(pt,-0.05,500),curveGroup[curveIndex+1].setPoints(points),curveGroup[curveIndex+1]
.setClass(curveClass[eigen.color])}function setSolutionLine(pt,lineGroup,lineIndex){lineGroup[lineIndex].setXY(0,0,pt.x,pt.y),lineGroup[lineIndex].setClass(curveClass[eigen.color])}function setSolutionArrow(pt,arrowGroup,arrowIndex){var nextPt=getSolutionPoints(pt,.02,5),deltaX=nextPt[2]-pt.x,deltaY=nextPt[3]-pt.y,slope;deltaX!==0&&(slope=deltaY/deltaX),arrowGroup[arrowIndex].setXY(pt.x,pt.y,nextPt[2],nextPt[3]),arrowGroup[arrowIndex].setClass(diamondClass[eigen.color])}function setSolutionDiamond(pt,diamondGroup,diamondIndex){diamondGroup[diamondIndex].setXY(pt.x,pt.y),diamondGroup[diamondIndex].setClass(diamondClass[eigen.color])}function removeSolutionArrow(){var arrow=userArrows[userArrows.length-1];arrow.line.parentNode.removeChild(arrow.line),arrow.head.parentNode.removeChild(arrow.head),userArrows.pop()}function removeSolutionDiamond(){var diamond=userDiamonds[userDiamonds.length-1];diamond.point.parentNode.removeChild(diamond.point),userDiamonds.pop()}function clearShapes(shapeGroup
,shapeType){_.each(shapeGroup,function(shape){shapeType==="curve"?shape.polyline.parentNode.removeChild(shape.polyline):shapeType==="line"?shape.line.parentNode.removeChild(shape.line):shapeType==="arrow"?(shape.line.parentNode.removeChild(shape.line),shape.head.parentNode.removeChild(shape.head)):shape.point.parentNode.removeChild(shape.point)}),shapeGroup.length=0}function getSolutionPoints(pt0,step,nbrSteps){var pt1,pt2,points=[],i=0;pt1=pt0;while(i<nbrSteps&&inAllowedBounds(pt1))pt2=U.rk4(pt1,step,dxdt,dydt),points.push(pt1.x),points.push(pt1.y),pt1=pt2,i++;return points}function Point2D(x,y){this.x=x,this.y=y}function Vector2D(x,y){this.x=x,this.y=y,this.decimalDigits=2,this.toString=function(){var xStr=this.x.toFixed(this.decimalDigits),yStr=this.y.toFixed(this.decimalDigits);return"( "+xStr+" , "+yStr+" )"},this.toComplexString=function(){var x=roundToZeroWhenSmall(this.x),y=roundToZeroWhenSmall(this.y),xAbsStr=Math.abs(x).toFixed(this.decimalDigits),yAbsStr=Math.abs(y).toFixed(this
.decimalDigits),yStr=yAbsStr+" i",minusStr=" "+U.STR.minus+" ",plusStr=" "+U.STR.plus+" ";return x>0?y<0?xAbsStr+minusStr+yStr:y===0?xAbsStr:xAbsStr+plusStr+yStr:x===0?y<0?U.STR.minus+yStr:y===0?xAbsStr:yStr:y<0?U.STR.minus+xAbsStr+minusStr+yStr:y===0?U.STR.minus+xAbsStr:U.STR.minus+xAbsStr+plusStr+yStr}}function roundToZeroWhenSmall(val){var small=.01;return Math.abs(val)<.01?0:val}function getEigen(){var disc,r,s,result;return tr=trace(a,b,c,d),det=determinant(a,b,c,d),disc=tr*tr-4*det,r=tr/2,s=disc/4,result={},s>0?(det<0?(result.color="cyan",result.zone="saddle"):det===0?(result.color="red",result.zone="degenerate"):(result.color="green",tr<0?result.zone="nodal sink":result.zone="nodal source"),result.eigen1=new Vector2D(r-Math.sqrt(s),0),result.eigen2=new Vector2D(r+Math.sqrt(s),0)):s===0?(result.color="red",tr<0?result.zone="defective nodal sink":tr===0?result.zone="degenerate":result.zone="defective nodal source",result.eigen1=new Vector2D(r,0),result.eigen2=new Vector2D(r,0)):(tr<0?
(result.color="yellow",result.zone="spiral sink"):tr===0?(result.color="red",result.zone="center"):(result.color="yellow",result.zone="spiral source"),result.eigen1=new Vector2D(r,-Math.sqrt(-s)),result.eigen2=new Vector2D(r,Math.sqrt(-s))),result}function matrixIsZero(a11,a12,a21,a22){return a11===0&a12===0&&a21===0&&a22===0}function regionIsDiamond(pt){return det===0&&pt.y===0||matrixIsZero(a,b,c,d)||pt.x===0&&pt.y===0}function trace(a11,a12,a21,a22){return a11+a22}function determinant(a11,a12,a21,a22){return a11*a22-a12*a21}});