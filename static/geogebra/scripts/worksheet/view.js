window.GGBT_wsf_view=function($,general){"use strict";var APPLET_DETACHED_HTML='<li><a class="wsf-detach-applet toolbar-button"></a></li>',detachedAppletWindow=null,fullscreenContainer=null,fullscreenOriginalParent=null;if(!general){console.log("general not loaded")}function getFullscreenContainer(){if(fullscreenContainer===null){fullscreenContainer=$('<div id="fullscreencontainer"><div id="fullscreenapplet"></div></div>').on("click",function(e){if(e.currentTarget===e.target){toggleAppletFullscreen(false)}}).appendTo("body");$(document).on("keydown",function(e){if(e.keyCode===27&&getFullscreenContainer().hasClass("fullscreen")){toggleAppletFullscreen(false)}})}return fullscreenContainer}function initWsfTeacherInfoButton(){var button=$(".wsf-teacher-info-button");button.off("click").on("click",function(e){e.preventDefault();general.initTeacherInfoPage($(this))})}function initWsfElementInfoButton(){var buttons=$(".wsf-element-info-button");buttons.off("click").on("click",function(e){e.preventDefault();var parent=$(this).parents(".worksheet_element");general.setWsfActiveContent(parent);general.initElementInfoPage($(this))})}function toggleAppletFullscreen(button){var article,width,height,wwidth=$(window).width(),wheight=$(window).height(),scale;if(button){fullscreenOriginalParent=button.parents(".worksheet_element");article=fullscreenOriginalParent.find("article");width=parseInt(article.attr("data-param-width"),10)+20;height=parseInt(article.attr("data-param-height"),10)+20;scale=Math.min(wwidth/width,wheight/height);article.attr("data-scalex",scale).attr("data-scaley",scale);article.appendTo(getFullscreenContainer().find("#fullscreenapplet").css("transform","scale("+scale+")"));getFullscreenContainer().addClass("fullscreen")}else{article=getFullscreenContainer().find("article");getFullscreenContainer().removeClass("fullscreen");getFullscreenContainer().find("article").removeAttr("data-scalex").removeAttr("data-scaley").appendTo(fullscreenOriginalParent.find(".applet_container").empty());fullscreenOriginalParent=null}if(window[article.attr("data-param-id")]){window[article.attr("data-param-id")].recalculateEnvironments()}}function initWsfFullscreenButton(){var buttons=$(".wsf-element-fullscreen-button");buttons.off("click").on("click",function(e){e.preventDefault();toggleAppletFullscreen($(this))})}function initWsfButtonInformation(){var button=general.getButtonInfoClose();button.off("click").on("click",function(e){general.closeInfoFromView();e.preventDefault()})}function initSaveExerciseButtons(mode){if(!window.GGBT_gen_edit){return}window.GGBT_gen_edit.initSaveAndContinue(function(e){var setDone=null;e.preventDefault();if($(".button.jRestart").length){setDone=false}saveUserExamData(setDone,false,function(success){if(success){var doneURL=window.GGBT_gen_edit.getDoneURL();if(e.target.href){if(doneURL&&e.target.href.indexOf("doneurl")<0&&e.target.href.indexOf(doneURL)<0){window.location=e.target.href+"/doneurl/"+encodeURIComponent(doneURL).replace(/%2F/g,"%252F");return}window.location=e.target.href}}})},".jSave");if($(".ws-element-question").length>0){window.GGBT_gen_edit.initSave(function(e){var save=window.confirm($(".jDone").data("confirm"));if(save){var login=false;if($(".jWs-tools").length!==0){login=$(".jWs-tools").data("user_id")!==undefined&&$(".jWs-tools").data("user_id")>0?true:false}else{login=$(".wsf-worksheet-title").data("login")?false:true}if(login){saveUserExamData(true,false,function done(success){if(success){location.reload()}})}else{markAnswers();$(".jDone").hide();$(".jRestart").show()}}},".jDone")}else{$(".jDone").hide()}window.GGBT_gen_edit.initSaveAndClose(function(e){var setDone=null;e.preventDefault();if($(".button.jRestart").length){setDone=false}saveUserExamData(setDone,false,function(success){if(success){var doneURL=window.GGBT_gen_edit.getDoneURL();if(e.target.href){if(doneURL&&e.target.href.indexOf("doneurl")<0&&e.target.href.indexOf(doneURL)<0){window.location=e.target.href+"/doneurl/"+encodeURIComponent(doneURL).replace(/%2F/g,"%252F");return}window.location=e.target.href}else if(doneURL){window.location=doneURL}}})},".jSaveAndClose");window.GGBT_gen_edit.initSaveAndContinue(function(e){var save=window.confirm($(".jRestart").data("confirm"));if(save){saveUserExamData(false,true,function done(success){if(success){location.reload()}})}},".jRestart");saveAndClose(mode);$(".ws-element-restart-button").click(function(){if(!window.confirm($(this).data("confirm"))){return}var element=$(this).parents(".worksheet_element");var exercise=$(".ws-element-exercise",element);var material_id=$(exercise).data("material_id");if(window["applet_"+material_id]===undefined){alert("The applet could not be restarted");return}var applet=window["applet_"+material_id].getAppletObject();applet.setBase64(exercise.data("oribase64"))})}function markAnswers(){$(".ws-question-choices").each(function(){markAnswerOfQuestion($(this))});$(".ws-element-question-answertext").each(function(){$(this).find(".ws-open-question-solution").show()})}function markAnswerOfQuestion(question){question.find(".ws-question-choice").each(function(){if($(this).data("ticked")===true){$(this).addClass("ticked")}if(question.data("multiple")===0){if($(this).find(":input").is(":checked")&&$(this).data("ticked")===true){$(this).find(".answer").addClass("correct");$(this).find(".answer").removeClass("placeholder")}else if($(this).find(":input").is(":checked")&&$(this).data("ticked")!==true){$(this).find(".answer").addClass("incorrect");$(this).find(".answer").removeClass("placeholder")}}else{if($(this).find(":input").is(":checked")&&$(this).data("ticked")===true||!$(this).find(":input").is(":checked")&&$(this).data("ticked")!==true){$(this).find(".answer").addClass("correct");$(this).find(".answer").removeClass("placeholder")}else{$(this).find(".answer").addClass("incorrect");$(this).find(".answer").removeClass("placeholder")}}})}function initSaveEvalButtons(mode){$(".wsf-exercise-toolbar").hide();if(!window.GGBT_gen_edit){return}$("#student_worksheets").on("change",function(e){if($(".eval.select").length==$(".edit").length){saveEvalData(false)}e.preventDefault();$(this).attr("name",$(this).val());window.location=$("#student_worksheets").attr("name")});$(".wsf-evaluation-toolbar.edit .eval").on("click",function(e){$(this).parents(".wsf-evaluation-toolbar").find(".select").not($(this)).each(function(idx,elem){$(elem).removeClass("select")});if(!$(this).hasClass("select")){$(this).addClass("select")}else{$(this).removeClass("select")}saveEvalData(false,function done(success){if($(".eval.select").length>0){$(".button.jReopen").show()}else{$(".button.jReopen").hide()}})});window.GGBT_gen_edit.initSave(function(e){var redo=window.confirm($(".jReopen").data("confirm"));if(redo){saveEvalData(true,function done(success){if(success){window.location.reload()}})}},".jReopen");saveAndClose(mode)}function saveAndClose(mode){window.GGBT_gen_edit.initSave(function(e){if(mode==="eval"){if($(".eval.select",general.getPage()).length==$(".edit",general.getPage()).length){saveEvalData(false,function done(success){if(success){windowClose()}})}else{windowClose()}}else if(mode==="exercise"){var confirm=$(".jCancel",general.getPage()).data("confirm");if(confirm){window.GGBT_gen_modal.showYesNoPopup(confirm,onYes,windowClose,$(".jWs-tools",general.getPage()).data("yes"),$(".jWs-tools",general.getPage()).data("no"),$(".jWs-tools",general.getPage()).data("cancel"))}else{windowClose()}}else{windowClose()}function onYes(){saveUserExamData(null,false,function done(success){if(success){windowClose()}})}function windowClose(){if(window.opener){window.opener.location.reload();window.close()}else if(e.target.href){window.location=e.target.href}else if($(".jCancel",general.getPage()).href!==""){window.location=$(".jCancel",general.getPage()).get(0).href}}},".jCancel")}function getUserExamData(setDone,reset,worksheet){var data={elements:[]};var isDone=true;$(".ws-element-question",worksheet).each(function(idx,question){var questionData=getQuestionData(question);data.elements.push(questionData);if(questionData.data.answers.length===0){isDone=false}});$(".ws-element-exercise",worksheet).each(function(idx,exercise){var exerciseData=getExerciseData(exercise);var oriBase64=$(exercise).data("oribase64");data.elements.push(exerciseData);if(exerciseData.data.ggb64===undefined||exerciseData.data.ggb64===oriBase64){isDone=false}});if(setDone===false){data.markAsDone=false}else if(setDone===true){data.markAsDone=true}else{data.markAsDone=isDone||setDone}if(reset===true){data.reset=true}return data}function getQuestionData(question){var data={id:$(question).data("id"),data:{hasData:true}};var choices=$(".ws-question-choice",question);if(choices.length){data.data.answers=[];$("input:checked",choices).each(function(idx,choice){data.data.answers.push($(choice).data("id"))});data.data.type="tf"}else{data.data.answers=$(".ws-element-question-answertext textarea",question).val();data.data.type="txt"}if(data.data.answers.length===0){data.data.hasData=false}return data}function getExerciseData(exercise){var data={id:$(exercise).data("id"),data:{hasData:true}};var material_id=$(exercise).data("material_id");if(window["applet_"+material_id]===undefined){return data}var applet=window["applet_"+material_id].getAppletObject();if(typeof applet==="object"){var ggb64=applet.getBase64();if($("article",exercise).data("param-ggbbase64")!==ggb64){data.data.ggb64=ggb64}}return data}function saveUserExamData(setDone,reset,done){window.GGBT_gen_edit.setSaveStateInProgress();var worksheet=general.getPage();var data=getUserExamData(setDone,reset,worksheet);data.markAsGraded=false;var fail=function(msg){window.GGBT_gen_edit.setSaveStateError(msg);if(done!==undefined){done(false)}};var url=false;if($(".jWs-tools",worksheet).length!==0){url=$(".jWs-tools",worksheet).data("saveurl")}else{url=$(".save-wrapper").data("saveurl")}$.post(url,{data:data}).done(function(result){if(result.type==="success"){window.GGBT_gen_edit.setSaveStateSuccessful();if(done!==undefined){done(true)}}else{fail(result.message)}}).fail(function(result){fail(result.responseText)})}function saveEvalData(reopen,done){window.GGBT_gen_edit.setSaveStateInProgress();var page=general.getPage();var user_id=false;if($(".jStudent",page).length!==0){user_id=$(".jStudent",page).data("exercise-student")}else{user_id=$(".wsf-worksheet-title",page).data("exercise-student")}var data={user_id:user_id,markAsGraded:false,markAsDone:true,elements:[]};$(".wsf-evaluation-toolbar",page).each(function(){var mat_eval={id:$(this).parents(".worksheet_element").data("mat-id"),data:{hasData:true}},mat_click=$(this).find(".select");if($(mat_click).length>0&&typeof $(mat_click).data("points")!=="undefined"){mat_eval.points=$(mat_click).data("points")}else{mat_eval.points=null}data.elements.push(mat_eval)});var element_count=$(".ws-element-question, .ws-element-exercise",page).length,select_count=$(".select",page).length;if(element_count===select_count){data.markAsGraded=true}else if(select_count===0){data.markAsDone=false}if(reopen){data.markAsDone=false;data.markAsGraded=false}var fail=function(msg){window.GGBT_gen_edit.setSaveStateError(msg);if(done!==undefined){done(false)}};var url=false;if($(".jWs-tools",page).length!==0){url=$(".jWs-tools",page).data("saveurl")}else{url=$(".save-wrapper",page).data("saveurl")}$.post(url,{data:data}).done(function(result){if(result.type==="success"){window.GGBT_gen_edit.setSaveStateSuccessful();if(done!==undefined){if(result.newData){$(".student-state",page).text($(".student-state",page).data(result.newData))}done(true)}}else{fail(result.message)}}).fail(function(result){fail(result.responseText)})}function initButtons(){initWsfTeacherInfoButton();initWsfElementInfoButton();initWsfButtonInformation();initWsfFullscreenButton();var mode=$(general.getWorkSheet().get(0)).data("mode");if(mode==="eval"){initSaveEvalButtons(mode)}else{initSaveExerciseButtons(mode)}initToolBar()}function initQuestionElements(){jQuery.fn.elasticArea=function(){return this.each(function(){function resizeTextarea(textarea){textarea.style.height=textarea.scrollHeight/2+"px";textarea.style.height=textarea.scrollHeight+"px"}$(this).keypress(function(e){resizeTextarea(e.target)}).keydown(function(e){resizeTextarea(e.target)}).keyup(function(e){resizeTextarea(e.target)}).css("overflow","hidden");resizeTextarea(this)})};$(".ws-element-question-answertext textarea").elasticArea()}function initWebElements(){console.info("WEB: view.initWebElements()");$(".jModal").each(function(){GGBT_wsf_general.initWebElement($(this))})}function initToolBar(){$('.worksheet_element[data-type="G"], .worksheet_element[data-type="E"]',general.getWorkSheet()).each(function(idx,elem){var header=$(".ws-element-header.notitle",elem);var width;if($("article",elem).length){width=$("article",elem).data("param-width")}else if($(".applet_container",elem).length){width=$(".applet_container",elem).width()}if(header.length&&width!==undefined){if($("ul li",header).length>1){header.addClass("widetoolbar");$(".wsf-element-toolbar",header).css({right:(width-header.width())*-1})}else{$(".wsf-element-toolbar",header).css({right:(width-header.width()+25)*-1})}}})}function setAppletFixed(button){var applet=button.parents(".worksheet_element"),article,width,height;article=applet.find("article");article.attr("data-param-id","detachedApplet");width=parseInt(article.attr("data-param-width"),10);height=parseInt(article.attr("data-param-height"),10);if(detachedAppletWindow!==null){detachedAppletWindow.close();localStorage.removeItem("detached");localStorage.removeItem("detachedApplet")}renderGGBElement(article.get(0),function(){window.detachedApplet.registerUpdateListener("detachedAppletUpdated")});detachedAppletWindow=window.open("http://"+window.location.host+"/material/detachapplet/","GeoGebra Applet","width="+(width+16)+", height="+(height+16));localStorage.setItem("detachedApplet",article.clone().addClass("geogebraweb").attr("data-param-usebrowserforjs","true").empty().get(0).outerHTML)}function initAppletControlEvents(html){var fragment=$(html);fragment.find(".wsf-detach-applet").on("click",function(e){setAppletFixed($(this))});return fragment}function initAppletControls(c){if(c.find("article[data-param-fixapplet=true]").length&&!c.find(".wsf-detach-applet").length){c.find(".wsf-element-toolbar").prepend(initAppletControlEvents(APPLET_DETACHED_HTML))}}function initNewWorksheet(worksheet){var oldWorksheet=general.getWorkSheet();general.setWorksheet(worksheet);initButtons();$(".worksheet_tbl .bbcode-text",worksheet).each(function(){var bbcode=this.textContent||this.innerText;var html=window.GGBT_texthandlers.getHTMLFromBBCode(bbcode);$(this).removeClass(".bbcode-text");$(this).html(html);if(window.GGBT_texthandlers.isLatexRenderer("mathquill")){$(".mathquill-embedded-latex",this).mathquill()}else{window.GGBT_jlatexmath.drawLatexOnjQuery($(".jlatexmath",this))}});if(oldWorksheet&&oldWorksheet.length>0){general.setWorksheet(oldWorksheet)}resizeVideos(false)}function initSyncMessageHandler(){window.addEventListener("storage",function(e){var article;var base64=localStorage.getItem("detached");if(base64){window.detachedApplet.setBase64(base64)}else if(detachedAppletWindow!==null&&detachedAppletWindow.closed){article=$("article[data-param-id=detachedApplet]").removeAttr("data-param-id");renderGGBElement(article.get(0));window.detachedApplet=null;localStorage.removeItem("detachedApplet");localStorage.removeItem("detached")}},false);window.detachedAppletUpdated=function(){if(window.detachedApplet){window.detachedApplet.getBase64(function(base64){localStorage.setItem("detached",base64)})}};window.addEventListener("beforeunload",function(e){localStorage.removeItem("detachedApplet");localStorage.removeItem("detached")})}var resizeVideos=function(allWS){var videos=allWS?$(".ws-element-video iframe"):$(".ws-element-video iframe",general.getWorkSheet());videos.each(function(i,e){var windowWidth=typeof window.innerWidth==="number"?window.innerWidth:document.documentElement.clientWidth;var wsRect=$(e).parents(".wsf-ws-scroller")[0].getBoundingClientRect();var rect=e.getBoundingClientRect();var videoBorder=(rect.left-wsRect.left)*2;$(e).css({maxWidth:windowWidth-videoBorder});$(e).parent().css({maxWidth:windowWidth-videoBorder})})};function initResize(){resizeVideos(true);$(window).resize(function(){resizeVideos(true)})}function init(){initResize();general.getWorkSheet();general.getWsfInfoContent();general.getWsfInfo();initButtons();initQuestionElements();initWebElements();setGraded();logInPopUp();initSyncMessageHandler()}function setGraded(){if($(".student-state",general.getPage()).text()===$(".student-state",general.getPage()).data("done")){if($(".wsf-evaluation-toolbar.edit",general.getPage()).length===$(".eval.select",general.getPage()).length){saveEvalData(false,function done(success){if(success){location.reload()}})}}}function logInPopUp(){var login,loginURL,page=general.getPage();if($(".jWs-tools",page).length!==0){login=$(".jWs-tools",page).data("loginmsg");loginURL=$(".jWs-tools",page).data("loginurl")}else{login=$(".wsf-worksheet-title",page).data("login");loginURL=$(".wsf-worksheet-title",page).data("loginurl")}if(login){var redirect=window.confirm(login);if(redirect){window.location=loginURL}else{$(".button.save",page).hide()}}}function setData(d){general.setData(d)}function postProcessApplet(container){if(container){initAppletControls(container.parents(".wsf-content-added"));general.adjustContentToResize(container.parents(".ws-element-applet, .ws-element-exercise"))}}return{init:init,setData:setData,initNewWorksheet:initNewWorksheet,postProcessApplet:postProcessApplet}}(jQuery,GGBT_wsf_general);jQuery(document).ready(function(){"use strict";GGBT_wsf_view.init()});window.GGBT_wsf_comments=function(){"use strict";var data=null;function setData(newData){data=newData;window.GGBT_comments.setData({loggedinuser_id:data.loggedinuser_id,user_right:data.user_right})}function appendToElement(obj){var element=null;if(obj.element_id>0){element=$("#worksheet_element_"+obj.element_id)}else{element=$("#worksheet_element_global")}var comments=element.find(".comments");if(comments.length<=0){return}element.find(".comments.post-comments .count").attr("display");var allowComment=data.loggedinuser_id!==-1&&!(data.type==="C"&&data.user_right==="V");if(!allowComment){comments.find(".new-comment").hide()}obj.commentsArray.forEach(function(item){window.GGBT_comments.appendToCommentList($(".comments-list",element),item);if(item.date_lastread&&item.date_created>item.date_lastread&&item.userid!==data.loggedinuser_id){$(".post-comments",element).show()}});window.GGBT_comments.modifyCommentCounter({comments:comments,comments_counter:obj.comments,toggle:true});window.GGBT_comments.attachHandlersToNewComment(comments)}function populateComments(){data.elements.forEach(function(item){appendToElement(item)})}function populateCommentContent(){$(".post-comments").hide();$(".post-comments",$("#worksheet_element_global")).show();if(data&&data.elements&&data.elements.length){if(data.elements.length<=2){$(".j-worksheet-comment-button").hide()}populateComments()}}function init(){$(".j-worksheet-comment-button").on("click",function(){var container=$(this).parents(".worksheet_element");if(!$(".post-comments",container).is(":visible")){container.addClass("addComment");setTimeout(function(){container.removeClass("addComment")},1500)}$(".post-comments",container).toggle();$(".new-comment-text",container).focus()});populateCommentContent()}return{init:init,setData:setData}}();$(document).ready(function(){"use strict";window.GGBT_wsf_comments.init()});