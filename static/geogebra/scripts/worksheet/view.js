window.GGBT_wsf_view=function($,general){"use strict";var APPLET_DETACHED_HTML='<li><a class="wsf-detach-applet toolbar-button"></a></li>',detachedAppletWindow=null,fullscreenContainer=null,fullscreenOriginalParent=null;if(!general){console.log("general not loaded")}function getFullscreenContainer(){if(fullscreenContainer===null){fullscreenContainer=$('<div id="fullscreencontainer"><div id="fullscreenapplet"></div></div>').on("click",function(e){if(e.currentTarget===e.target){toggleAppletFullscreen(false)}}).appendTo("body");$(document).on("keydown",function(e){if(e.keyCode===27&&getFullscreenContainer().hasClass("fullscreen")){toggleAppletFullscreen(false)}})}return fullscreenContainer}function initWsfTeacherInfoButton(){var button=$(".wsf-teacher-info-button");button.off("click").on("click",function(e){e.preventDefault();general.initTeacherInfoPage($(this))})}function initWsfElementInfoButton(){var buttons=$(".wsf-element-info-button");buttons.off("click").on("click",function(e){e.preventDefault();var parent=$(this).parents(".worksheet_element");general.setWsfActiveContent(parent);general.initElementInfoPage($(this))})}function toggleAppletFullscreen(button){var article,width,height,wwidth=$(window).width(),wheight=$(window).height(),scale;if(button){fullscreenOriginalParent=button.parents(".worksheet_element");article=fullscreenOriginalParent.find("article");width=parseInt(article.attr("data-param-width"),10)+20;height=parseInt(article.attr("data-param-height"),10)+20;scale=Math.min(wwidth/width,wheight/height);article.removeAttr("data-scalex").removeAttr("data-scaley");article.attr("data-param-scale",scale);article.appendTo(getFullscreenContainer().find("#fullscreenapplet"));getFullscreenContainer().addClass("fullscreen")}else{article=getFullscreenContainer().find("article");getFullscreenContainer().removeClass("fullscreen");article.removeAttr("data-scalex").removeAttr("data-scaley");getFullscreenContainer().find("article").attr("data-param-scale","none").appendTo(fullscreenOriginalParent.find(".applet_container").empty());fullscreenOriginalParent=null}if(article.attr("data-param-id")){window[article.attr("data-param-id")].getBase64(function(base64){article.attr("data-param-ggbbase64",base64);renderGGBElement(article.get(0))})}else{renderGGBElement(article.get(0))}}function initWsfFullscreenButton(){var buttons=$(".wsf-element-fullscreen-button");buttons.off("click").on("click",function(e){e.preventDefault();toggleAppletFullscreen($(this))})}function initWsfButtonInformation(){var button=general.getButtonInfoClose();button.off("click").on("click",function(e){general.closeInfoFromView();e.preventDefault()})}function initSaveExerciseButtons(){if(!window.GGBT_gen_edit){return}window.GGBT_gen_edit.initSaveAndContinue(function(e){var setDone=null;if($(".button.restart").length){setDone=false}saveUserExamData(setDone,false)},".save");window.GGBT_gen_edit.initSave(function(e){var save=window.confirm($(".done.show").data("confirm"));if(save){saveUserExamData(true,false,function done(success){if(success){location.reload()}})}},".done.show");window.GGBT_gen_edit.initSaveAndContinue(function(e){var save=window.confirm($(".restart").data("confirm"));if(save){saveUserExamData(false,true,function done(success){if(success){location.reload()}})}},".restart");window.GGBT_gen_edit.initCancel(".cancel",true);$(".ws-element-restart-button").click(function(){if(!window.confirm($(this).data("confirm"))){return}var element=$(this).parents(".worksheet_element");var exercise=$(".ws-element-exercise",element);var material_id=$(exercise).data("material_id");if(window["applet_"+material_id]===undefined){alert("The applet could not be restarted");return}var applet=window["applet_"+material_id].getAppletObject();applet.setBase64(exercise.data("oribase64"))})}function initSaveEvalButtons(){if(!window.GGBT_gen_edit){return}$("#student_worksheets").on("change",function(e){if($(".eval.select").length==$(".edit").length){saveEvalData(false)}e.preventDefault();$(this).attr("name",$(this).val());window.location=$("#student_worksheets").attr("name")});if($(".wsf-evaluation-toolbar").hasClass("edit")){$(".eval").on("click",function(e){$(this).parents(".wsf-evaluation-toolbar").find(".select").not($(this)).each(function(idx,elem){$(elem).removeClass("select")});if(!$(this).hasClass("select")){$(this).addClass("select")}else{$(this).removeClass("select")}saveEvalData(false,function done(success){if($(".eval.select").length>0){$(".button.reopen").show()}else{$(".button.reopen").hide()}})})}window.GGBT_gen_edit.initSave(function(e){var redo=window.confirm($(".reopen").data("confirm"));if(redo){saveEvalData(true,function done(success){if(success){window.location.reload();$(".button.reopen").hide()}})}},".reopen");window.GGBT_gen_edit.initSave(function(e){if($(".eval.select").length==$(".edit").length){saveEvalData(false)}if(window.opener){window.opener.location.reload()}else if($(".cancel").data("doneurl")!==""){window.location=window.GGBT_gen_edit.getDoneURL()}window.close()},".cancel")}function getUserExamData(setDone,reset,worksheet){var data={elements:[]};var isDone=true;$(".ws-element-question",worksheet).each(function(idx,question){var questionData=getQuestionData(question);data.elements.push(questionData);if(questionData.data.answers.length===0){isDone=false}});$(".ws-element-exercise",worksheet).each(function(idx,exercise){var exerciseData=getExerciseData(exercise);var oriBase64=$(exercise).data("oribase64");data.elements.push(exerciseData);if(exerciseData.data.ggb64===undefined||exerciseData.data.ggb64===oriBase64){isDone=false}});if(setDone===false){data.markAsDone=false}else if(setDone===true){data.markAsDone=true}else{data.markAsDone=isDone||setDone}if(reset===true){data.reset=true}return data}function getQuestionData(question){var data={id:$(question).data("id"),data:{hasData:true}};var choices=$(".ws-question-choice",question);if(choices.length){data.data.answers=[];$("input:checked",choices).each(function(idx,choice){data.data.answers.push($(choice).data("id"))});data.data.type="tf"}else{data.data.answers=$(".ws-element-question-answertext textarea",question).val();data.data.type="txt"}if(data.data.answers.length===0){data.data.hasData=false}return data}function getExerciseData(exercise){var data={id:$(exercise).data("id"),data:{hasData:true}};var material_id=$(exercise).data("material_id");if(window["applet_"+material_id]===undefined){return data}var applet=window["applet_"+material_id].getAppletObject();var ggb64=applet.getBase64();if($("article",exercise).data("param-ggbbase64")!==ggb64){data.data.ggb64=ggb64}return data}function saveUserExamData(setDone,reset,done){window.GGBT_gen_edit.setSaveStateInProgress();var worksheet=window.GGBT_wsf_general.getWorkSheet();var data=getUserExamData(setDone,reset,worksheet);data.markAsGraded=false;var fail=function(msg){window.GGBT_gen_edit.setSaveStateError(msg);if(done!==undefined){done(false)}};$.post($(".save-wrapper").data("saveurl"),{data:data}).done(function(result){if(result.type==="success"){window.GGBT_gen_edit.setSaveStateSuccessful();if(done!==undefined){done(true)}}else{fail(result.message)}}).fail(function(result){fail(result.responseText)})}function saveEvalData(reopen,done){window.GGBT_gen_edit.setSaveStateInProgress();var data={user_id:$(".wsf-worksheet-title").data("exercise-student"),markAsGraded:false,markAsDone:true,elements:[]};$(".wsf-evaluation-toolbar").each(function(){var mat_eval={id:$(this).parents(".worksheet_element").data("mat-id"),data:{hasData:true}},mat_click=$(this).find(".select");if($(mat_click).length>0&&typeof $(mat_click).data("points")!=="undefined"){mat_eval.points=$(mat_click).data("points")}else{mat_eval.points=null}data.elements.push(mat_eval)});var element_count=$(".ws-element-question, .ws-element-exercise").length,select_count=$(".select").length;if(element_count===select_count){data.markAsGraded=true}else if(select_count===0){data.markAsDone=false}if(reopen){data.markAsDone=false;data.markAsGraded=false}var fail=function(msg){window.GGBT_gen_edit.setSaveStateError(msg);if(done!==undefined){done(false)}};$.post($(".save-wrapper").data("saveurl"),{data:data}).done(function(result){if(result.type==="success"){window.GGBT_gen_edit.setSaveStateSuccessful();if(done!==undefined){if(result.newData){$(".student-state").text($(".student-state").data(result.newData))}done(true)}}else{fail(result.message)}}).fail(function(result){fail(result.responseText)})}function initButtons(){initWsfTeacherInfoButton();initWsfElementInfoButton();initWsfButtonInformation();initWsfFullscreenButton();var mode=general.getWorkSheet().data("mode");if(mode==="eval"){initSaveEvalButtons()}else{initSaveExerciseButtons()}initToolBar()}function initQuestionElements(){jQuery.fn.elasticArea=function(){return this.each(function(){function resizeTextarea(textarea){textarea.style.height=textarea.scrollHeight/2+"px";textarea.style.height=textarea.scrollHeight+"px"}$(this).keypress(function(e){resizeTextarea(e.target)}).keydown(function(e){resizeTextarea(e.target)}).keyup(function(e){resizeTextarea(e.target)}).css("overflow","hidden");resizeTextarea(this)})};$(".ws-element-question-answertext textarea").elasticArea()}function initToolBar(){$('.worksheet_element[data-type="G"], .worksheet_element[data-type="E"]',general.getWorkSheet()).each(function(idx,elem){var header=$(".ws-element-header.notitle",elem);var width;if($("article",elem).length){width=$("article",elem).data("param-width")}else if($(".applet_container",elem).length){width=$(".applet_container",elem).width()}if(header.length&&width!==undefined){if($("ul li",header).length>1){header.addClass("widetoolbar");$(".wsf-element-toolbar",header).css({right:(width-header.width())*-1})}else{$(".wsf-element-toolbar",header).css({right:(width-header.width()+25)*-1})}}})}function setAppletFixed(button){var applet=button.parents(".worksheet_element"),article,width,height;article=applet.find("article");article.attr("data-param-id","detachedApplet");width=parseInt(article.attr("data-param-width"),10);height=parseInt(article.attr("data-param-height"),10);if(detachedAppletWindow!==null){detachedAppletWindow.close();localStorage.removeItem("detached");localStorage.removeItem("detachedApplet")}renderGGBElement(article.get(0),function(){window.detachedApplet.registerUpdateListener("detachedAppletUpdated")});detachedAppletWindow=window.open("http://"+window.location.host+"/material/detachapplet/","GeoGebra Applet","width="+(width+16)+", height="+(height+16));localStorage.setItem("detachedApplet",article.clone().addClass("geogebraweb").attr("data-param-usebrowserforjs","true").empty().get(0).outerHTML)}function initAppletControlEvents(html){var fragment=$(html);fragment.find(".wsf-detach-applet").on("click",function(e){setAppletFixed($(this))});return fragment}function initAppletControls(c){if(c.find("article[data-param-fixapplet=true]").length&&!c.find(".wsf-detach-applet").length){c.find(".wsf-element-toolbar").prepend(initAppletControlEvents(APPLET_DETACHED_HTML))}}function onLoadTextElements(processMathquill,allWorksheets){var texts;if(allWorksheets){texts=$(".worksheet_tbl .ws-bbcode-text")}else{texts=$(".worksheet_tbl .ws-bbcode-text",general.getWorkSheet())}texts.each(function(){var bbcode=this.textContent||this.innerText;if(bbcode===undefined){bbcode=""}var html=window.GGBT_gen_edit.getHTMLFromBBCode(bbcode);$(this).html(html);if(processMathquill){$(".mathquill-embedded-latex",this).mathquill()}})}function initNewWorksheet(worksheet){var oldWorksheet=general.getWorkSheet();general.setWorksheet(worksheet);initButtons();onLoadTextElements(true);if(oldWorksheet&&oldWorksheet.length>0){general.setWorksheet(oldWorksheet)}}function initSyncMessageHandler(){window.addEventListener("storage",function(e){var article;var base64=localStorage.getItem("detached");if(base64){window.detachedApplet.setBase64(base64)}else if(detachedAppletWindow!==null&&detachedAppletWindow.closed){article=$("article[data-param-id=detachedApplet]").removeAttr("data-param-id");renderGGBElement(article.get(0));window.detachedApplet=null;localStorage.removeItem("detachedApplet");localStorage.removeItem("detached")}},false);window.detachedAppletUpdated=function(){if(window.detachedApplet){window.detachedApplet.getBase64(function(base64){localStorage.setItem("detached",base64)})}};window.addEventListener("beforeunload",function(e){localStorage.removeItem("detachedApplet");localStorage.removeItem("detached")})}function init(){general.getWorkSheet();general.getWsfInfoContent();general.getWsfInfo();initButtons();initQuestionElements();onLoadTextElements(false,true);logInPopUp();initSyncMessageHandler()}function logInPopUp(){var login=$(".wsf-worksheet-title").data("login"),loginURL=$(".wsf-worksheet-title").data("loginurl");if(login){var redirect=window.confirm(login);if(redirect){window.location=loginURL}else{$(".button.save").hide()}}}function setData(d){general.setData(d)}function postProcessApplet(container){if(container){initAppletControls(container.parents(".wsf-content-added"));general.adjustContentToResize(container.parents(".ws-element-applet, .ws-element-exercise"))}}return{init:init,setData:setData,initNewWorksheet:initNewWorksheet,postProcessApplet:postProcessApplet}}(jQuery,GGBT_wsf_general);jQuery(document).ready(function(){"use strict";GGBT_wsf_view.init()});